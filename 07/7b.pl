#!/usr/bin/env perl

use strict;
use warnings;
use feature qw(say);
use Data::Dumper;

BEGIN {
    push @INC, '.';
}
use Machine;

my $program = <DATA>;
chomp $program;

my $max = "-inf";
my $perm;
for my $p (perm(5,6,7,8,9)) {
    my $val = test_sequence($program, $p);
    if($val > $max) {
	$max = $val;
	$perm = $p;
    }

}
print @$perm;
say " => $max";

sub perm {
    my @elements = @_;
    my @out;
    return [$elements[0]] if @elements == 1;
    for my $i (0 .. $#elements) {
	my @rest = @elements[0 .. $i-1, $i+1 .. $#elements];
	for my $perm (perm(@rest)) {
	    push @out, [$elements[$i], @$perm]
	}
    }
    return @out
}

sub test_sequence {
    my ($program, $sequence) = @_;

    my ($a_in, $b_in, $c_in, $d_in, $e_in) = (
        [$sequence->[0], 0],
        [$sequence->[1]],
        [$sequence->[2]],
        [$sequence->[3]],
        [$sequence->[4]],
    );

    my $a = Machine->new($program, $a_in, $b_in);
    my $b = Machine->new($program, $b_in, $c_in);
    my $c = Machine->new($program, $c_in, $d_in);
    my $d = Machine->new($program, $d_in, $e_in);
    my $e = Machine->new($program, $e_in, $a_in);

    my @machines = ($a, $b, $c, $d, $e);

    my $i = 0;
    while (1) {
	my $j = $i % 5;
        last if $e->{execution} eq 'halt';
	next if $machines[$j]->{execution} eq 'halt';
	$machines[$j]->run();
	$i++;
    }

    return $a_in->[0];
}

__DATA__
3,8,1001,8,10,8,105,1,0,0,21,46,55,76,89,106,187,268,349,430,99999,3,9,101,4,9,9,1002,9,2,9,101,5,9,9,1002,9,2,9,101,2,9,9,4,9,99,3,9,1002,9,5,9,4,9,99,3,9,1001,9,2,9,1002,9,4,9,101,2,9,9,1002,9,3,9,4,9,99,3,9,1001,9,3,9,1002,9,2,9,4,9,99,3,9,1002,9,4,9,1001,9,4,9,102,5,9,9,4,9,99,3,9,101,1,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,101,2,9,9,4,9,3,9,1001,9,1,9,4,9,3,9,101,1,9,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,99,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,1,9,9,4,9,3,9,101,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,1,9,4,9,3,9,101,2,9,9,4,9,3,9,1002,9,2,9,4,9,99,3,9,101,1,9,9,4,9,3,9,101,1,9,9,4,9,3,9,101,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,1001,9,2,9,4,9,3,9,1001,9,1,9,4,9,3,9,1001,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,99,3,9,101,1,9,9,4,9,3,9,102,2,9,9,4,9,3,9,101,2,9,9,4,9,3,9,101,1,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1002,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,2,9,4,9,3,9,102,2,9,9,4,9,3,9,101,1,9,9,4,9,99,3,9,1001,9,1,9,4,9,3,9,1001,9,1,9,4,9,3,9,102,2,9,9,4,9,3,9,102,2,9,9,4,9,3,9,1001,9,1,9,4,9,3,9,1001,9,1,9,4,9,3,9,1001,9,1,9,4,9,3,9,1002,9,2,9,4,9,3,9,101,2,9,9,4,9,3,9,101,1,9,9,4,9,99
